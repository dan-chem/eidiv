{% extends "base.html" %}
{% load static %}
{% block content %}
<h1 class="text-xl font-semibold mb-4">Dienst erfassen</h1>

<form method="post" class="space-y-8">
  {% csrf_token %}

  <!-- Allgemein -->
  <section class="bg-white p-4 rounded shadow">
    <h2 class="font-semibold mb-3">Allgemeine Angaben</h2>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div>
        <label class="block text-sm font-medium">Titel</label>
        {{ form.titel }}
      </div>
      <div>
        <label class="block text-sm font-medium">Beginn</label>
        {{ form.start_dt }}
      </div>
      <div>
        <label class="block text-sm font-medium">Ende</label>
        {{ form.ende_dt }}
      </div>
      <div class="md:col-span-2">
        <label class="block text-sm font-medium">Beschreibung</label>
        {{ form.beschreibung }}
      </div>
    </div>
    {% if form.non_field_errors %}<p class="text-red-600 mt-2">{{ form.non_field_errors }}</p>{% endif %}
  </section>

  <!-- Fahrzeuge -->
  <section class="bg-white p-4 rounded shadow">
    <h2 class="font-semibold mb-3">Fahrzeuge</h2>
    {{ fv_formset.management_form }}
    <table class="w-full text-sm">
      <thead>
        <tr class="text-left border-b">
          <th class="py-2">Fahrzeug</th>
          <th class="py-2" style="width:120px;">km</th>
          <th class="py-2" style="width:100px;">Std.</th>
          <th class="py-2" style="width:100px;">Aktion</th>
        </tr>
      </thead>
      <tbody id="fv_tbody">
        {% for f in fv_formset %}
        <tr class="border-b">
          <td class="py-1">{{ f.fahrzeug }}</td>
          <td class="py-1">{{ f.kilometer }}</td>
          <td class="py-1">{{ f.stunden }}</td>
          <td class="py-1">
            {% if f.instance.pk %}{{ f.DELETE }} löschen{% endif %}
            {{ f.id }}
          </td>
        </tr>
        {% empty %}
        {% endfor %}
      </tbody>
    </table>
    <button type="button"
            class="mt-2 px-3 py-1 border rounded text-sm"
            hx-get="{% url 'dienst_htmx_add_fahrzeug' %}"
            hx-target="#fv_tbody"
            hx-swap="beforeend"
            data-formset-prefix="fv">
    + Zeile hinzufügen
    </button>
  </section>

  <!-- Anhänger -->
  <section class="bg-white p-4 rounded shadow">
    <h2 class="font-semibold mb-3">Anhänger</h2>
    {{ an_formset.management_form }}
    <table class="w-full text-sm">
      <thead>
        <tr class="text-left border-b">
          <th class="py-2">Anhänger</th>
          <th class="py-2" style="width:120px;">km</th>
          <th class="py-2" style="width:100px;">Std.</th>
          <th class="py-2" style="width:100px;">Aktion</th>
        </tr>
      </thead>
      <tbody id="an_tbody">
        {% for a in an_formset %}
        <tr class="border-b">
          <td class="py-1">{{ a.anhaenger }}</td>
          <td class="py-1">{{ a.kilometer }}</td>
          <td class="py-1">{{ a.stunden }}</td>
          <td class="py-1">
            {% if a.instance.pk %}{{ a.DELETE }} löschen{% endif %}
            {{ a.id }}
          </td>
        </tr>
        {% empty %}
        {% endfor %}
      </tbody>
    </table>
    <button type="button"
            class="mt-2 px-3 py-1 border rounded text-sm"
            hx-get="{% url 'dienst_htmx_add_anhaenger' %}"
            hx-target="#an_tbody"
            hx-swap="beforeend"
            data-formset-prefix="an">
    + Zeile hinzufügen
    </button>
  </section>

  <!-- Abrollbehälter -->
   <section class="bg-white p-4 rounded shadow">
  <h2 class="font-semibold mb-3">Abrollbehälter</h2>
  {{ ab_formset.management_form }}
  <table class="w-full text-sm">
    <thead>
      <tr class="text-left border-b">
        <th class="py-2">Abrollbehälter</th>
        <th class="py-2" style="width:120px;">erforderlich</th>
        <th class="py-2" style="width:100px;">Aktion</th>
      </tr>
    </thead>
    <tbody id="ab_tbody">
      {% for f in ab_formset %}
        {% include "dienst/_abroll_row.html" with form=f %}
      {% empty %}
      {% endfor %}
    </tbody>
  </table>
  <button type="button"
          class="mt-2 px-3 py-1 border rounded text-sm"
          hx-get="{% url 'dienst_htmx_add_abroll' %}"
          hx-target="#ab_tbody"
          hx-swap="beforeend"
          data-formset-prefix="ab">
    + Zeile hinzufügen
  </button>
</section>

  <!-- Teilnahmen (Checkboxliste aller Mitglieder) -->
  <section class="bg-white p-4 rounded shadow">
    <h2 class="font-semibold mb-3">Teilnehmende</h2>

    {{ tn_formset.management_form|default_if_none:"" }}
    <table class="w-full text-sm">
      <thead>
        <tr class="text-left border-b">
          <th class="py-2" style="width:120px;">Teilnahme</th>
          <th class="py-2">Mitglied</th>
          <th class="py-2">Fahrzeug/Funktion</th>
          <th class="py-2" style="width:120px;">AGT (Min)</th>
        </tr>
      </thead>
      <tbody id="tn_tbody">
        {% for form, m in tn_rows %}
        <tr class="border-b" data-agt="{{ m.agt|yesno:'1,0' }}">
          <td class="py-1">
            {{ form.selected }}
            {{ form.mitglied_id }}
          </td>
          <td class="py-1">
            {{ m.vorname }} {{ m.name }}
            {% if m.agt %}<span class="ml-2 text-xs px-2 py-0.5 rounded bg-green-100 text-green-800">AGT</span>{% endif %}
          </td>
          <td class="py-1">
            {{ form.fahrzeug_funktion }}
            {% if form.fahrzeug_funktion.errors %}<div class="text-red-600 text-xs">{{ form.fahrzeug_funktion.errors|join:", " }}</div>{% endif %}
          </td>
          <td class="py-1">
            {{ form.agt_minuten }}
            {% if form.agt_minuten.errors %}<div class="text-red-600 text-xs">{{ form.agt_minuten.errors|join:", " }}</div>{% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </section>

  <div>
    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded">Speichern</button>
  </div>
</form>

<script>
  // Teilnahme-Checkbox steuert Eingaben; AGT-Minuten nur für AGT-Mitglieder
  (function(){
    const rows = document.querySelectorAll('#tn_tbody tr');
    function updateRow(tr){
      const isAGT = tr.getAttribute('data-agt') === '1';
      const cb = tr.querySelector('input[type="checkbox"]');
      const fun = tr.querySelector('input[name$="-fahrzeug_funktion"]');
      const agt = tr.querySelector('input[name$="-agt_minuten"]');
      if (!cb || !fun || !agt) return;
      const checked = cb.checked;
      // Funktion nur bei Teilnahme
      fun.disabled = !checked;
      // AGT-Minuten nur bei Teilnahme und nur für AGT-Mitglieder
      if (isAGT) {
        agt.disabled = !checked;
      } else {
        agt.value = "";
        agt.disabled = true;
      }
      if (!checked) {
        fun.value = "";
        if (isAGT) agt.value = "";
      }
    }
    rows.forEach(tr => {
      const cb = tr.querySelector('input[type="checkbox"]');
      if (cb) {
        cb.addEventListener('change', () => updateRow(tr));
        updateRow(tr); // initial
      }
    });
  })();
</script>

{% endblock %}
