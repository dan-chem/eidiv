{% extends "base.html" %}
{% load static %}
{% block content %}
<h1 class="text-xl font-semibold mb-4">Dienst erfassen</h1>

<form method="post" class="space-y-8">
  {% csrf_token %}

  <!-- Allgemein -->
  <section class="bg-white p-4 rounded shadow">
    <h2 class="font-semibold mb-3">Allgemeine Angaben</h2>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div>
        <label class="block text-sm font-medium">Titel</label>
        {{ form.titel }}
      </div>
      <div>
        <label class="block text-sm font-medium">Beginn</label>
        {{ form.start_dt }}
      </div>
      <div>
        <label class="block text-sm font-medium">Ende</label>
        {{ form.ende_dt }}
      </div>
      <div class="md:col-span-2">
        <label class="block text-sm font-medium">Beschreibung</label>
        {{ form.beschreibung }}
      </div>
    </div>
    {% if form.non_field_errors %}<p class="text-red-600 mt-2">{{ form.non_field_errors }}</p>{% endif %}
  </section>

  <!-- Fahrzeuge -->
  <section class="bg-white p-4 rounded shadow">
    <h2 class="font-semibold mb-3">Fahrzeuge</h2>
    {{ fv_formset.management_form }}
    <table class="w-full text-sm">
      <thead>
        <tr class="text-left border-b">
          <th class="py-2">Fahrzeug</th>
          <th class="py-2" style="width:120px;">km</th>
          <th class="py-2" style="width:100px;">Std.</th>
          <th class="py-2" style="width:100px;">Aktion</th>
        </tr>
      </thead>
      <tbody id="fv_tbody">
        {% for f in fv_formset %}
        <tr class="border-b">
          <td class="py-1">{{ f.fahrzeug }}</td>
          <td class="py-1">{{ f.kilometer }}</td>
          <td class="py-1">{{ f.stunden }}</td>
          <td class="py-1">
            {% if f.instance.pk %}{{ f.DELETE }} löschen{% endif %}
            {{ f.id }}
          </td>
        </tr>
        {% empty %}
        {% endfor %}
      </tbody>
    </table>
        <button type="button"
          class="mt-2 px-3 py-1 border rounded text-sm"
          hx-get="{% url 'dienst_htmx_add_fahrzeug' %}"
          hx-target="#fv_tbody"
          hx-swap="beforeend"
          hx-include="input[name='fv-TOTAL_FORMS']"
          data-formset-prefix="fv">
        + Zeile hinzufügen
        </button>
  </section>

  <!-- Anhänger -->
  <section class="bg-white p-4 rounded shadow">
    <h2 class="font-semibold mb-3">Anhänger</h2>
    {{ an_formset.management_form }}
    <table class="w-full text-sm">
      <thead>
        <tr class="text-left border-b">
          <th class="py-2">Anhänger</th>
          <th class="py-2" style="width:120px;">km</th>
          <th class="py-2" style="width:100px;">Std.</th>
          <th class="py-2" style="width:100px;">Aktion</th>
        </tr>
      </thead>
      <tbody id="an_tbody">
        {% for a in an_formset %}
        <tr class="border-b">
          <td class="py-1">{{ a.anhaenger }}</td>
          <td class="py-1">{{ a.kilometer }}</td>
          <td class="py-1">{{ a.stunden }}</td>
          <td class="py-1">
            {% if a.instance.pk %}{{ a.DELETE }} löschen{% endif %}
            {{ a.id }}
          </td>
        </tr>
        {% empty %}
        {% endfor %}
      </tbody>
    </table>
        <button type="button"
          class="mt-2 px-3 py-1 border rounded text-sm"
          hx-get="{% url 'dienst_htmx_add_anhaenger' %}"
          hx-target="#an_tbody"
          hx-swap="beforeend"
          hx-include="input[name='an-TOTAL_FORMS']"
          data-formset-prefix="an">
        + Zeile hinzufügen
        </button>
  </section>

  <!-- Abrollbehälter -->
   <section class="bg-white p-4 rounded shadow">
  <h2 class="font-semibold mb-3">Abrollbehälter</h2>
  {{ ab_formset.management_form }}
  <table class="w-full text-sm">
    <thead>
      <tr class="text-left border-b">
        <th class="py-2">Abrollbehälter</th>
        <th class="py-2" style="width:120px;">erforderlich</th>
        <th class="py-2" style="width:100px;">Aktion</th>
      </tr>
    </thead>
    <tbody id="ab_tbody">
      {% for f in ab_formset %}
        {% include "dienst/_abroll_row.html" with form=f %}
      {% empty %}
      {% endfor %}
    </tbody>
  </table>
  <button type="button"
          class="mt-2 px-3 py-1 border rounded text-sm"
          hx-get="{% url 'dienst_htmx_add_abroll' %}"
          hx-target="#ab_tbody"
          hx-swap="beforeend"
          hx-include="input[name='ab-TOTAL_FORMS']"
          data-formset-prefix="ab">
    + Zeile hinzufügen
  </button>
</section>

<!-- Teilnahmen (zwei Blöcke: Aktive, Jugendfeuerwehr) -->
<section class="bg-white p-4 rounded shadow">
  <h2 class="font-semibold mb-3">Teilnehmende</h2>

  <!-- Live-Suche -->
  <div class="mb-3">
    <input id="memberFilterDienst"
           type="search"
           placeholder="Mitglieder filtern (Name)"
           class="w-full border rounded px-3 py-2"
           autocomplete="off">
  </div>

  {{ tn_formset.management_form|default_if_none:"" }}

  <h3 class="font-medium mb-1">Aktive</h3>
  <table class="w-full text-sm mb-4">
    <thead>
      <tr class="text-left border-b">
        <th class="py-2" style="width:120px;">Teilnahme</th>
        <th class="py-2">Mitglied</th>
        <th class="py-2">Fahrzeug/Funktion</th>
        <th class="py-2" style="width:120px;">AGT (Min)</th>
      </tr>
    </thead>
    <tbody id="tn_tbody_active">
      {% for row in tn_rows_active %}
        {% if row.show_initial %}
          <tr class="bg-gray-50">
            <td colspan="4" class="py-1 font-semibold">{{ row.initial }}</td>
          </tr>
        {% endif %}
        <tr class="border-b"
            data-agt="{{ row.m.agt|yesno:'1,0' }}"
            data-search="{{ row.m.name }}, {{ row.m.vorname }} {{ row.m.vorname }} {{ row.m.name }}">
          <td class="py-1">{{ row.form.selected }} {{ row.form.mitglied_id }}</td>
          <td class="py-1">
            {{ row.m.name }}, {{ row.m.vorname }}
            {% if row.m.agt %}<span class="ml-2 text-xs px-2 py-0.5 rounded bg-green-100 text-green-800">AGT</span>{% endif %}
          </td>
          <td class="py-1">{{ row.form.fahrzeug_funktion }}{% if row.form.fahrzeug_funktion.errors %}<div class="text-red-600 text-xs">{{ row.form.fahrzeug_funktion.errors|join:", " }}</div>{% endif %}</td>
          <td class="py-1">{{ row.form.agt_minuten }}{% if row.form.agt_minuten.errors %}<div class="text-red-600 text-xs">{{ row.form.agt_minuten.errors|join:", " }}</div>{% endif %}</td>
        </tr>
      {% endfor %}
    </tbody>
  </table>

  {% if tn_rows_jf %}
  <h3 class="font-medium mb-1">Jugendfeuerwehr</h3>
  <table class="w-full text-sm">
    <thead>
      <tr class="text-left border-b">
        <th class="py-2" style="width:120px;">Teilnahme</th>
        <th class="py-2">Mitglied</th>
        <th class="py-2">Fahrzeug/Funktion</th>
        <th class="py-2" style="width:120px;">AGT (Min)</th>
      </tr>
    </thead>
    <tbody id="tn_tbody_jf">
      {% for row in tn_rows_jf %}
        {% if row.show_initial %}
          <tr class="bg-gray-50">
            <td colspan="4" class="py-1 font-semibold">{{ row.initial }}</td>
          </tr>
        {% endif %}
        <tr class="border-b"
            data-agt="{{ row.m.agt|yesno:'1,0' }}"
            data-search="{{ row.m.name }}, {{ row.m.vorname }} {{ row.m.vorname }} {{ row.m.name }}">
          <td class="py-1">{{ row.form.selected }} {{ row.form.mitglied_id }}</td>
          <td class="py-1">
            {{ row.m.name }}, {{ row.m.vorname }}
            {% if row.m.agt %}<span class="badge badge-agt ml-2">AGT</span>{% endif %}
          </td>
          <td class="py-1">{{ row.form.fahrzeug_funktion }}{% if row.form.fahrzeug_funktion.errors %}<div class="text-red-600 text-xs">{{ row.form.fahrzeug_funktion.errors|join:", " }}</div>{% endif %}</td>
          <td class="py-1 agt-cell">
            {{ row.form.agt_minuten }}
            {% if row.form.agt_minuten.errors %}
              <div class="text-red-600 text-xs">{{ row.form.agt_minuten.errors|join:", " }}</div>
            {% endif %}
          </td>
        </tr>
      {% endfor %}
    </tbody>
  </table>
  {% endif %}
</section>

  <div>
    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded">Speichern</button>
  </div>
</form>

<script>
  (function(){
    const rows = document.querySelectorAll('#tn_tbody_active tr[data-search], #tn_tbody_jf tr[data-search]');
    function updateRow(tr){
      const isAGT = tr.getAttribute('data-agt') === '1';
      const cb = tr.querySelector('input[type="checkbox"]');
      const fun = tr.querySelector('input[name$="-fahrzeug_funktion"]');
      const agt = tr.querySelector('input[name$="-agt_minuten"]');
      const agtTd = agt ? agt.closest('td') : null;
      if (!cb || !fun || !agt || !agtTd) return;

      const checked = cb.checked;

      fun.disabled = !checked;

      if (isAGT) {
        agt.disabled = !checked;
        agtTd.classList.remove('agt-off');
      } else {
        agt.value = "";
        agt.disabled = true;
        agtTd.classList.add('agt-off');
      }

      if (!checked) {
        fun.value = "";
        if (isAGT) agt.value = "";
      }
    }
    rows.forEach(tr => {
      const cb = tr.querySelector('input[type="checkbox"]');
      if (cb) {
        cb.addEventListener('change', () => updateRow(tr));
        updateRow(tr);
      }
    });
  })();

  // Live-Suche nur echte Datenzeilen filtern
  (function(){
    const q = document.getElementById('memberFilterDienst');
    const containers = ['tn_tbody_active', 'tn_tbody_jf'].map(id => document.getElementById(id)).filter(Boolean);
    function filterRows(){
      const term = (q?.value || '').trim().toLowerCase();
      containers.forEach(tb => {
        tb.querySelectorAll('tr[data-search]').forEach(tr => {
          const hay = (tr.dataset.search || '').toLowerCase();
          tr.style.display = (!term || hay.includes(term)) ? '' : 'none';
        });
      });
    }
    if (q) { q.addEventListener('input', filterRows); filterRows(); }
  })();
</script>

{% endblock %}
